<!DOCTYPE html>
<html>
    <head>
        <title>Prueba Parser</title>

        <!-- CSS JQuery UI -->
        <link rel="stylesheet" href="https://code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">
        <script src="https://code.jquery.com/jquery-1.10.2.js"></script>
        <script src="https://code.jquery.com/ui/1.11.4/jquery-ui.js"></script>

        <!-- CSS Adicional -->
        <link href="css/styles.css" rel='stylesheet'>
        
        <!-- Latest compiled and minified CSS -->
        <!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css"> -->

        <!-- Etiquetas -->
        <meta charset="utf-8">

        <!-- Bibliotecas JQuery -->
        <script src="https://code.jquery.com/jquery-1.10.2.js"></script>
        <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
        <script src="https://code.jquery.com/ui/1.11.4/jquery-ui.min.js"></script>
        <script src="https://code.jquery.com/ui/1.11.4/jquery-ui.js"></script>

                <script src="include/base64.js"></script>
        <script src="include/util.js"></script>
        <script src="include/websock.js"></script>
        

        <!-- Este es el que está fallando a la hora de crear las ventanas y por eso no me sale la cruceta. -->
        <!--<script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>-->
        <script src="js/ventana.js"></script>
    </head>

    <body>

    
        <input type="button" value="GeneralParser" onclick="parserXML(xml)"/>
        <input type="button" value="Conectar" onclick="connect()"/>

    
    <script>
        var globalDebug = true;    

        var xml = '<a><defTextVector device="CCD Simulator" name="DRIVER_INFO" label="Driver Info" group="Options" state="Ok" perm="ro" timeout="60" timestamp="2015-09-22T14:55:11"><defText name="DRIVER_NAME" label="Name">CCD Simulator</defText><defText name="DRIVER_EXEC" label="Exec">indi_simulator_ccd</defText><defText name="DRIVER_VERSION" label="Version">1.0</defText><defText name="DRIVER_INTERFACE" label="Interface">22</defText></defTextVector><defTextVector device="OtroSimulator" name="DRIVER_INFO" label="Driver Info" group="Options" state="Idle" perm="ro" timeout="60" timestamp="2015-09-22T14:55:11"><defText name="DRIVER_NAME" label="Name">CCD Simulator</defText><defText name="DRIVER_EXEC" label="Exec">indi_simulator_ccd</defText><defText name="DRIVER_VERSION" label="Version">1.0</defText><defText name="DRIVER_INTERFACE" label="Interface">22</defText></defTextVector><defSwitchVector device="Telescope Simulator" name="DEBUG" label="Debug" group="Options" state="Idle" perm="rw" rule="OneOfMany" timeout="0" timestamp="2015-09-24T10:07:49"><defSwitch name="ENABLE" label="Enable">Off</defSwitch><defSwitch name="DISABLE" label="Disable">On</defSwitch></defSwitchVector><defNumberVector device="Telescope Simulator" name="EQUATORIAL_EOD_COORD" label="Eq. Coordinates" group="Main Control" state="Idle" perm="rw" timeout="60" timestamp="2015-09-24T10:09:36"><defNumber name="RA" label="RA (hh:mm:ss)" format="%010.6m" min="0" max="24" step="0">0</defNumber><defNumber name="DEC" label="DEC (dd:mm:ss)" format="%010.6m" min="-90" max="90" step="0">0</defNumber></defNumberVector><defNumberVector device="CCD Simulator" name="FILTER_SLOT" label="Filter Slot" group="Filter Wheel" state="Idle" perm="rw" timeout="60" timestamp="2015-09-28T16:27:32"><defNumber name="FILTER_SLOT_VALUE" label="Filter" format="%3.0f" min="1" max="5" step="1">1</defNumber></defNumberVector><defTextVector device="CCD Simulator" name="FILTER_NAME" label="Filter names" group="Filter Wheel" state="Alert" perm="rw" timeout="0" timestamp="2015-09-28T16:27:32"><defText name="FILTER_SLOT_NAME_1" label="Filter#1">Red</defText><defText name="FILTER_SLOT_NAME_2" label="Filter#2">Green</defText><defText name="FILTER_SLOT_NAME_3" label="Filter#3">Blue</defText><defText name="FILTER_SLOT_NAME_4" label="Filter#4">H_Alpha</defText><defText name="FILTER_SLOT_NAME_5" label="Filter#5">Luminosity</defText></defTextVector><defBLOBVector device="CCD Simulator" name="CCD1" label="Image Data" group="Image Info" state="Idle" perm="ro" timeout="60" timestamp="2015-09-28T16:27:32"><defBLOB name="CCD1" label="Image"/></defBLOBVector><setSwitchVector device="CCD Simulator" name="CCD_COOLER" state="Busy" timeout="0" timestamp="2015-09-28T16:35:20"><oneSwitch name="COOLER_ON">On</oneSwitch><oneSwitch name="COOLER_OFF">Off</oneSwitch></setSwitchVector><defSwitchVector device="CCD Simulator" name="CONNECTION" label="Connection" group="Main Control" state="Idle" perm="rw" rule="OneOfMany" timeout="60" timestamp="2015-10-15T09:45:26"><defSwitch name="CONNECT" label="Connect">Off</defSwitch><defSwitch name="DISCONNECT" label="Disconnect">On</defSwitch></defSwitchVector><defSwitchVector device="Telescope Simulator" name="CONFIG_PROCESS" label="Configuration" group="Options" state="Idle" perm="rw" rule="AtMostOne" timeout="0" timestamp="2015-10-15T11:44:12"><defSwitch name="CONFIG_LOAD" label="Load">Off</defSwitch><defSwitch name="CONFIG_SAVE" label="Save">Off</defSwitch><defSwitch name="CONFIG_DEFAULT" label="Default">Off</defSwitch></defSwitchVector><defLightVector device="CCD Simulator" name="Ejemplo_LUZ" label="Ejemplo Luz" group="Options" state="Ok" timeout="60" timestamp="2015-09-22T14:55:11"><defLight name="Luz1" label="Luz 1">Alert</defLight><defLight name="Luz2" label="Luz 2">Ok</defLight><defLight name="Luz3" label="Luz 3">Idle</defLight><defLight name="Luz4" label="Luz 4">Busy</defLight></defLightVector><setTextVector device="CCD Simulator" name="FILTER_NAME" state="Ok" timeout="0" timestamp="2015-10-23T10:13:31"><oneText name="FILTER_SLOT_NAME_1">Otro</oneText><oneText name="FILTER_SLOT_NAME_2">Verde</oneText><oneText name="FILTER_SLOT_NAME_3">Azul</oneText><oneText name="FILTER_SLOT_NAME_4">H_Alpha</oneText><oneText name="FILTER_SLOT_NAME_5">Luminosidad</oneText></setTextVector></a>';
       

        function parserXML(xml){
            var parser = new DOMParser();
            var indiXml = parser.parseFromString(xml,'text/xml');
            var indiSectionArray = indiXml.getElementsByTagName('a');
            debug(indiSectionArray.length);
            for (var i=0; i < indiSectionArray.length; i++) {
                                
                var children = indiSectionArray[i].childNodes; 
                
                for(var j=0; j < children.length; j++) {
                    debug(children[j].nodeName);
                    var nodeName = children[j].nodeName;

                    if(nodeName == 'defTextVector'){
                        parserDefTextVector(children[j]);
                    }

                    if(nodeName == 'defNumberVector'){
                        parserDefNumberVector(children[j]);
                    }   

                    if(nodeName == 'defSwitchVector'){
                        parserDefSwitchVector(children[j]);
                    } 

                    if(nodeName == 'defBLOBVector'){
                        parserDefBLOBVector(children[j]);                
                    }

                    if(nodeName == 'defLightVector'){
                        parserDefLightVector(children[j]);
                    }

                    if(nodeName == 'setTextVector'){
                        parserSetTextVector(children[j]);
                    }
                }
            }
        }

        /*
         *
         *Funciones de definición de los diferentes tipos: Text - Number - Siwtch - BLOB - Light
         *
         **/

        function parserDefTextVector(node){
            var deviceName = node.getAttribute("device");
            var propertyName = node.getAttribute("name");
            var groupName = node.getAttribute("group"); 

            debug(deviceName);
            var windowId = getWindowId(deviceName);
            debug(windowId);
            
            var antiguaVentana = getVentana(deviceName);

            var html = "";

            html += '<div class="deviceInfo">';
                html += '<div class="propertyBox">'+
                '<div>' + 
                getBombillita(node.getAttribute("state"), getPropertyId(deviceName,propertyName) + "_bombilla") + node.getAttribute("name") + '</div>';
                 html += '</div>';

                var nodes = node.childNodes;

                if(nodes.length > 0){
                    html += '<div class="elementBoxContainer">';
                    for (var i=0; i < nodes.length; i++) {
                        var elementName = nodes[i].getAttribute("name");
                        html += 
                        '<div class = "elementBox">' + nodes[i].getAttribute("label") + "-&gt;" + 
                            '<div id=' + getElementId(deviceName,propertyName,elementName) + "_value" + '>' + 
                                nodes[i].innerHTML + 
                            '</div>' +
                            getInputText(node.getAttribute("perm")) + 
                        '</div>';                   
                    }

                   html += '</div>';

               }

                if(node.getAttribute("perm") != 'ro'){
                    html +=  '<button id="updateButton" class="btn btn-default" style="float:right">Actualizar</button>';
                }

            html += '</div>';

            addDeviceToTab(deviceName, groupName, html);           
        }

        function parserDefNumberVector(node){
            var deviceName = node.getAttribute("device");
            var propertyName = node.getAttribute("name"); 
            var groupName = node.getAttribute("group");        

            debug(deviceName);
            var windowId = getWindowId(deviceName);
            debug(windowId);

            var antiguaVentana = getVentana(deviceName);

            var html = "";
            
            html += '<div class="deviceInfo">';
                html += '<div class="propertyBox">'+
                '<div>' + 
                getBombillita(node.getAttribute("state"), getPropertyId(deviceName,propertyName) + "_bombilla") + node.getAttribute("name") + '</div>';
                 html += '</div>';

                var nodes = node.childNodes;

                if(nodes.length > 0){
                    html += '<div class = "elementBoxContainer">';
                        for(var i = 0; i < nodes.length; i++){  
                            var elementName = nodes[i].getAttribute("name");
                            html += 
                            '<div class = "elementBox">' + nodes[i].getAttribute("label") + "-&gt;" + 
                                '<div id=' + getElementId(deviceName,propertyName,elementName) + "_value" + '>' + 
                                    nodes[i].innerHTML + 
                                '</div>' +
                                getInputNumber(node.getAttribute("perm"), nodes[i]) + 
                            '</div>';  
                        }

                    html += '</div>';

                    if(node.getAttribute("perm") != 'ro'){
                        html +=  '<button id="updateButton" class="btn btn-default" style="float:right">Actualizar</button>';
                    }
                }
            html += '</div>';

            addDeviceToTab(deviceName, groupName, html);
            
        }

        function parserDefSwitchVector(node){
            var deviceName = node.getAttribute("device");
            var propertyName = node.getAttribute("name"); 
            var groupName = node.getAttribute("group");        

            debug(deviceName);
            var windowId = getWindowId(deviceName);
            debug(windowId);

            var antiguaVentana = getVentana(deviceName);

            var html = "";

            html += '<div class="deviceInfo">';
                html += '<div class="propertyBox">'+
                '<div>' + 
                getBombillita(node.getAttribute("state"), getPropertyId(deviceName,propertyName) + "_bombilla") + node.getAttribute("name") + '</div>';
                 html += '</div>';

                var nodes = node.childNodes;

                if(nodes.length > 0){
                    html += '<div class = "elementBoxContainer">';
                        for(var i = 0; i < nodes.length; i++){  
                            html += 
                            '<div class = "elementBox">'+ nodes[i].getAttribute("label") + 
                                getInputSwitch(node.getAttribute("rule"), nodes[i], node.getAttribute("perm"), node.getAttribute("name")) + 
                            '</div>';
                        }

                    html += '</div>';
                }
            html += '</div>';

            addDeviceToTab(deviceName, groupName, html);
        }

        function parserDefBLOBVector(node){
            var deviceName = node.getAttribute("device");
            var propertyName = node.getAttribute("name"); 
            var groupName = node.getAttribute("group");        

            debug(deviceName);
            var windowId = getWindowId(deviceName);
            debug(windowId);

            var antiguaVentana = getVentana(deviceName);

            var html = "";
            
            html += '<div class="deviceInfo">';
                html += '<div class="propertyBox">'+
                '<div>' + 
                getBombillita(node.getAttribute("state"), getPropertyId(deviceName,propertyName) + "_bombilla") + node.getAttribute("name") + '</div>';
                 html += '</div>';

                var nodes = node.childNodes;

                var nodes = node.childNodes;

                if(nodes.length > 0){
                    html += '<div class = "elementBoxContainer">';
                        for(var i = 0; i < nodes.length; i++){
                            var elementName = nodes[i].getAttribute("name");  
                            html += 
                            '<div class = "elementBox">'+ nodes[i].getAttribute("label")   + '-&gt; ' + 
                                '<div id=' + getElementId(deviceName,propertyName,elementName) + "_value" + '>' + 
                                    '<input type="text" placeholder="SizeBLOB">' + 
                                    '<input type="text" placeholder="FormatBLOB">' + 
                                '</div>' + 
                            '</div>';
                        }

                    html += '</div>';

                    if(node.getAttribute("perm") != 'ro'){
                        html +=  '<button id="updateButton" class="btn btn-default" style="float:right">Actualizar</button>';
                    }
                }
            html += '</div>';

            addDeviceToTab(deviceName, groupName, html);
        }

        function parserDefLightVector(node){
            var deviceName = node.getAttribute("device");
            var propertyName = node.getAttribute("name"); 
            var groupName = node.getAttribute("group");        

            debug(deviceName);
            var windowId = getWindowId(deviceName);
            debug(windowId);

            var antiguaVentana = getVentana(deviceName);

            var html = "";
            
            html += '<div class="deviceInfo">';
                html += '<div class="propertyBox">'+
                '<div>' + 
                getBombillita(node.getAttribute("state"), getPropertyId(deviceName,propertyName) + "_bombilla") + node.getAttribute("name") + '</div>';
                 html += '</div>';

                var nodes = node.childNodes;

                if(nodes.length > 0){
                    html += '<div class = "elementBoxContainer">';
                        for(var i = 0; i < nodes.length; i++){  
                            var elementName = nodes[i].getAttribute("name"); 
                            html += 
                            '<div class = "elementBox">'+ nodes[i].getAttribute("label")   + '-&gt; ' + 
                                '<div id=' + getElementId(deviceName,propertyName,elementName) + "_value" + '>' + 
                                    getBombillita(nodes[i].innerHTML, getPropertyId(deviceName,propertyName) + "_bombilla") + 
                                '</div>' + 
                            '</div>';
                        }

                    html += '</div>';
                }
            html += '</div>';

            addDeviceToTab(deviceName, groupName, html);    
        }


        /*
         *
         *Funciones de modificación de los diferentes tipos: Text - Number - Siwtch - BLOB - Light
         *
         **/

        function parserSetTextVector(node){
            var deviceName = node.getAttribute("device");
            var propertyName = node.getAttribute("name");

            var nodes = node.childNodes;

            debug("LLEGA AL PARSER"); 

            for(var i = 0; i < nodes.length; i++){
                var elementName = nodes[i].getAttribute("name");
                debug("NODES DE I:");
                debug(nodes[i]);

                '<div id=' + document.getElementsByTagName(getElementId(deviceName,propertyName,elementName) + "_value" )+ '>' + 
                                nodes[i].innerHTML + 
                '</div>'

                var filter = document.getElementsByTagName("FILTER_SLOT_NAME_1");

                debug("DEPURANDO");
                debug(filter);


                /*
                var id= document.getElementsByTagName(getElementId(deviceName,propertyName,elementName) + "_value" );

                 debug("Esto es el id: " + id);
                */
            }


      
        }  




        /*Funciones Auxiliares para los diferentes parsers*/

        function addDeviceToTab(deviceName, groupName, html) {
            var antiguoTab = getTab(deviceName, groupName);
            var windowId = getWindowId(deviceName);
            antiguoTab.innerHTML += html;

            var active = $( "#" + windowId + "_tabs" ).tabs( "option", "active" );

            if (!active) {
                $( "#" + windowId + "_tabs" ).tabs({
                  active: 0
                 });
            }
            
        }

        function getInputText(perm){
            if(perm != 'ro'){
                return '<input type="text" placeholder="Modificar" class = "updateBox">';
            }
            else{
                return "";
            }
        }

        function getInputNumber(perm, node){
            if(perm != 'ro'){
                    return '<input type="number" id="numerics" min=' + node.getAttribute("min") + ' max = ' + node.getAttribute("max") + ' title="Format: [format: ' + node.getAttribute("format") + ", " + node.getAttribute("min") + ", " + node.getAttribute("max") + ", "  + node.getAttribute("step") +' ]">';               
            }
            else{
                return "";
            }
        }

        function getInputSwitch(rule, node, perm, name){
            switch(rule){
                //Uno de muchos
                case 'OneOfMany':
                if(perm != 'ro'){
                    /*Combo con las opciones que vayan saliendo.*/
                    return '<input type="submit" name='+ node.getAttribute("name") +' value ='+ node.innerHTML +'>';
                }
                /*Combo pero que la primera opción sea en blanco para que así se pueda dejar vacía.*/
                case 'AtMostOne':
                if(perm != 'ro'){
                    return '<input type="submit" name='+ node.getAttribute("name") +' value ='+ node.innerHTML +'>';;
                }
                //Los que sean. Utilizar un checkbox.
                /*Poner todos los checkbox y seleccionar todos los que se quieran de todos ellos.*/
                case 'AnyOfMany':
                if(perm != 'ro'){
                    return '<input type="submit" name='+ node.getAttribute("name") +' value ='+ node.innerHTML +'>';
                }
            }            
        }

        function debug(message){
            if(globalDebug){
                console.log(message);
            }
        }

        function getWindowId(deviceName){
            return deviceName.replace(/[\W_]/g,"_");
        }

        function getPropertyId(deviceName, propertyName){
            var concat = deviceName + "_" + propertyName;

            return concat.replace(/[\W_]/g,"_");
        }

        function getElementId(deviceName, propertyName, elementName){
            var concat = deviceName + "_" + propertyName + "_" + elementName;

            return concat.replace(/[\W_]/g,"_");
        }

        function getBombillita(state, id){

            switch(state){
                case 'Idle':
                return '<img src="images/grey_light.png" id="'+ id +'"/>';

                case 'Ok':
                return '<img src="images/green_light.png" id="'+ id +'"/>';

                case 'Alert':
                return '<img src="images/red_light.png" id="'+ id +'"/>';

                case 'Busy':
                return '<img src="images/yellow_light.png" id="'+ id +'"/>';
            }
        }

        function getVentana(deviceName){
            var windowId = getWindowId(deviceName);
            var antiguaVentana = document.getElementById(windowId);

            if(antiguaVentana == null){
                //Añadimos la nueva ventana al body
                $('body').append('<div class="deviceWindow" id="' + windowId + '"><div id="'+ windowId +'_tabs" class="windowTabs"><ul></ul></div>' + '</div>');

                $( "#" + windowId + '_tabs' ).tabs();
                //Inicializacíon de la nueva ventana
                var dialog = $('#' + windowId).dialog({
                    title: deviceName,
                    width: '500px',
                }); 
                antiguaVentana = document.getElementById(windowId);
            }
            else{
                debug("Ya existe");
            }

            return antiguaVentana;
        }

        function getTabId(deviceName, groupName){
            var concat = deviceName + "_" + groupName;
            return concat.replace(/[\W_]/g,"_");
        }

        function getTab(deviceName, groupName){
            var tabId = getTabId(deviceName, groupName);
            var windowId = getWindowId(deviceName);

            var antiguoTab = document.getElementById(tabId);

            if(antiguoTab == null){

                var windowTabs = $( "#" + windowId + '_tabs' );

                var html = '<div id="' + tabId + '" class="tabGroup">' + '</div>';

                windowTabs.append(html);

                var html2 = "<li><a href='#"+ tabId +"'>" + groupName + "</a></li>";

                windowTabs.find( ".ui-tabs-nav" ).append( html2);

                antiguoTab = document.getElementById(tabId);

                windowTabs.tabs( "refresh" );
            }
            return antiguoTab;
        }
    </script>

    <script>
        var ws;  
            
        function disconnect() {
          if (ws != null) {
            console.log("Desconectando");
            ws.close();
            ws = null;
          }
        }
            
        function connect() {
            disconnect();
           
            ws = new Websock();
           
             ws.on('message', funcionLectura);
           
            ws.on('open', function(e) {
                console.log(">> WebSockets.onopen");
                ws.send_string("<getProperties version=\"1.7\"/>");
                console.log("<< WebSockets.onopen");
            });
           
            ws.on('close', function(e) {
                console.log(">> WebSockets.onclose");
                console.log("<< WebSockets.onclose");
            });
           
            ws.on('error', function(e) {
                console.log(">> WebSockets.onerror");
                console.log("<< WebSockets.onerror");
            });
           
            console.log("Conectando...");
            ws.open("ws://localhost:4000");
        }
            
        function funcionLectura() {
            var length = ws.rQlen();
            var cadena = ws.rQshiftStr(length);
          
            console.log(cadena);

            parserXML("<a>" + cadena + "</a>");
        }
    </script>
    </body>
</html>