<!DOCTYPE html>
<html>
    <head>
        <title>Prueba Parser</title>

        <!-- CSS JQuery UI -->
        <link rel="stylesheet" href="http://code.jquery.com/ui/1.11.4/themes/flick/jquery-ui.css" type="text/css" />

        <!-- CSS Adicional -->
        <link href="css/styles.css" rel='stylesheet'>
        
        <!-- Latest compiled and minified CSS -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">

        <!-- Etiquetas -->
        <meta charset="utf-8">

        <!-- Bibliotecas JQuery -->
        <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
        <script src="https://code.jquery.com/ui/1.11.4/jquery-ui.min.js"></script>
        
        <!-- Latest compiled and minified JavaScript -->
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
        <script src="js/ventana.js"></script>
    </head>

    <body>

		<input type="button" value="defTextVector" onclick="readBasicElements('defTextVector')"/>
		<input type="button" value="defSwitchVector" onclick="readBasicElements('defSwitchVector')"/>
        <input type="button" value="defNumberVector" onclick="readNumberElements('defNumberVector')"/>
        <input type="button" value="defBLOBVector" onclick="readBasicElements('defBLOBVector')"/>
        <input type="button" value="GeneralParser" onclick="parserXML()"/>


	
        <script>

        var globalDebug = true;    

        var xml = '<a><defTextVector device="CCD Simulator" name="DRIVER_INFO" label="Driver Info" group="Options" state="Idle" perm="ro" timeout="60" timestamp="2015-09-22T14:55:11"><defText name="DRIVER_NAME" label="Name">CCD Simulator</defText><defText name="DRIVER_EXEC" label="Exec">indi_simulator_ccd</defText><defText name="DRIVER_VERSION" label="Version">1.0</defText><defText name="DRIVER_INTERFACE" label="Interface">22</defText></defTextVector><defTextVector device="OtroSimulator" name="DRIVER_INFO" label="Driver Info" group="Options" state="Idle" perm="ro" timeout="60" timestamp="2015-09-22T14:55:11"><defText name="DRIVER_NAME" label="Name">CCD Simulator</defText><defText name="DRIVER_EXEC" label="Exec">indi_simulator_ccd</defText><defText name="DRIVER_VERSION" label="Version">1.0</defText><defText name="DRIVER_INTERFACE" label="Interface">22</defText></defTextVector><defSwitchVector device="Telescope Simulator" name="DEBUG" label="Debug" group="Options" state="Idle" perm="rw" rule="OneOfMany" timeout="0" timestamp="2015-09-24T10:07:49"><defSwitch name="ENABLE" label="Enable">Off</defSwitch><defSwitch name="DISABLE" label="Disable">On</defSwitch></defSwitchVector><defNumberVector device="Telescope Simulator" name="EQUATORIAL_EOD_COORD" label="Eq. Coordinates" group="Main Control" state="Idle" perm="rw" timeout="60" timestamp="2015-09-24T10:09:36"><defNumber name="RA" label="RA (hh:mm:ss)" format="%010.6m" min="0" max="24" step="0">0</defNumber><defNumber name="DEC" label="DEC (dd:mm:ss)" format="%010.6m" min="-90" max="90" step="0">0</defNumber></defNumberVector><defNumberVector device="CCD Simulator" name="FILTER_SLOT" label="Filter Slot" group="Filter Wheel" state="Idle" perm="rw" timeout="60" timestamp="2015-09-28T16:27:32"><defNumber name="FILTER_SLOT_VALUE" label="Filter" format="%3.0f" min="1" max="5" step="1">1</defNumber></defNumberVector><defTextVector device="CCD Simulator" name="FILTER_NAME" label="Filter names" group="Filter Wheel" state="Idle" perm="rw" timeout="0" timestamp="2015-09-28T16:27:32"><defText name="FILTER_SLOT_NAME_1" label="Filter#1">Red</defText><defText name="FILTER_SLOT_NAME_2" label="Filter#2">Green</defText><defText name="FILTER_SLOT_NAME_3" label="Filter#3">Blue</defText><defText name="FILTER_SLOT_NAME_4" label="Filter#4">H_Alpha</defText><defText name="FILTER_SLOT_NAME_5" label="Filter#5">Luminosity</defText></defTextVector><defBLOBVector device="CCD Simulator" name="CCD1" label="Image Data" group="Image Info" state="Idle" perm="ro" timeout="60" timestamp="2015-09-28T16:27:32"><defBLOB name="CCD1" label="Image"/></defBLOBVector><setSwitchVector device="CCD Simulator" name="CCD_COOLER" state="Busy" timeout="0" timestamp="2015-09-28T16:35:20"><oneSwitch name="COOLER_ON">On</oneSwitch><oneSwitch name="COOLER_OFF">Off</oneSwitch></setSwitchVector></a>';

		function readBasicElements(vectorName){
		
			var parser = new DOMParser();
			var indiXml = parser.parseFromString(xml,'text/xml');

			var indiSectionArray = indiXml.getElementsByTagName(vectorName);

			for (var i=0; i < indiSectionArray.length; i++) {
				console.log(indiSectionArray[i].getAttribute("device"));
				
				var children = indiSectionArray[i].childNodes; 
				
				for(var j=0; j < children.length; j++) {
					console.log(children[j].getAttribute("name"));
					console.log(children[j].getAttribute("label"));
					console.log("value: " + children[j].innerHTML);
				}
				
				console.log("");
			}
		}

        function readNumberElements(vectorName){
        
            var parser = new DOMParser();
            var indiXml = parser.parseFromString(xml,'text/xml');

            var indiSectionArray = indiXml.getElementsByTagName(vectorName);

            for (var i=0; i < indiSectionArray.length; i++) {
                console.log(indiSectionArray[i].getAttribute("device"));
                
                var children = indiSectionArray[i].childNodes; 
                
                for(var j=0; j < children.length; j++) {
                    //console.log("name: " + children[j].getAttribute("name"));
                    console.log(children[j].getAttribute("label"));
                    console.log(children[j].getAttribute("format"));
                    console.log(children[j].getAttribute("min"));
                    console.log(children[j].getAttribute("max"));
                    console.log(children[j].getAttribute("step"));
                    console.log("value: " + children[j].innerHTML);
                }
                
                console.log("");
            }
        }

        function parserXML(){
        
            var parser = new DOMParser();
            var indiXml = parser.parseFromString(xml,'text/xml');

            var indiSectionArray = indiXml.getElementsByTagName('a');

            debug(indiSectionArray.length);

            for (var i=0; i < indiSectionArray.length; i++) {
                                
                var children = indiSectionArray[i].childNodes; 
                
                for(var j=0; j < children.length; j++) {
                    debug(children[j].nodeName);

                    var nodeName = children[j].nodeName;

                    if(nodeName == 'defTextVector'){
                        parserDefTextVector(children[j]);
                    }
                }
                
                debug("");
            }
        }

        function parserDefTextVector(node){
            var deviceName = node.getAttribute("device");
            debug(deviceName);

            var windowID = getWindowID(deviceName);
            debug(windowID);

            var antiguaVentana = document.getElementById(windowID);

            if(antiguaVentana == null){
                //Añadimos la nueva ventana al body
                $('body').append('<div class="deviceWindow" id="' + windowID + '">' + '</div>');

                //Inicializacíon de la nueva ventana
                var dialog = $('#' + windowID).dialog({
                    title : deviceName,
                }); 
                antiguaVentana = document.getElementById(windowID);
            }
            else{
                debug("Ya existe");
            }

            antiguaVentana.innerHTML = antiguaVentana.innerHTML + '<div class="propertyBox" >'  + node.getAttribute("name") + '<button id="boton_anadir" class="btn btn-default">Añadir</button>' + '</div>';
        }


        function debug(mensaje){
            if(globalDebug){
                console.log(mensaje);
            }
        }

        function getWindowID(deviceName){
            return deviceName.replace(/[\W_]/g,"_");
        }
    </script>

    </body>
</html>





